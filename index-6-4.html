<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Texas Precinct Dashboard</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;0,9..144,600;0,9..144,700;0,9..144,800;0,9..144,900;1,9..144,400&family=IBM+Plex+Mono:wght@400;500;600&family=Source+Sans+3:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">

  <style>
    :root {
      /* ── Warm Light Palette ── */
      --bg: #F5F1EB;
      --bg-warm: #EDE8E0;
      --sidebar-bg: #FDFCFA;
      --sidebar-bg2: #F9F7F3;
      --text: #1B1B28;
      --text-secondary: #3A3A52;
      --muted: #7C7B8E;
      --muted-light: #A8A7B8;
      --border: rgba(27, 27, 40, .09);
      --border-strong: rgba(27, 27, 40, .14);
      --border-hover: rgba(27, 27, 40, .22);
      --accent: #2B4A8C;
      --accent-light: #3D63B5;
      --accent-wash: rgba(43, 74, 140, .06);
      --accent-wash-strong: rgba(43, 74, 140, .10);
      --danger: #C0392B;
      --ok: #1E8449;
      --dem-color: #2264C7;
      --rep-color: #C0392B;

      /* ── Cards ── */
      --card-bg: #FFFFFF;
      --card-border: rgba(27, 27, 40, .08);
      --card-shadow: 
        0 1px 2px rgba(27,27,40,.04),
        0 4px 12px rgba(27,27,40,.06),
        0 12px 36px rgba(27,27,40,.05);
      --card-shadow-hover:
        0 1px 2px rgba(27,27,40,.05),
        0 6px 18px rgba(27,27,40,.08),
        0 16px 48px rgba(27,27,40,.07);

      /* ── Inputs ── */
      --input-bg: #FAFAF7;
      --input-border: rgba(27, 27, 40, .12);
      --input-focus: rgba(43, 74, 140, .25);

      /* ── Sizes ── */
      --radius: 12px;
      --radius-sm: 8px;
      --radius-xs: 6px;
      --sidebar-w: 400px;

      /* ── Typography ── */
      --font-display: 'Fraunces', 'Georgia', serif;
      --font-body: 'Source Sans 3', 'Segoe UI', sans-serif;
      --font-mono: 'IBM Plex Mono', 'SFMono-Regular', 'Consolas', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      font-size: 14px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ═══════════════════════════════════════════
       LAYOUT
       ═══════════════════════════════════════════ */
    .app {
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      height: 100%;
    }

    /* ── SIDEBAR ── */
    .sidebar {
      background: linear-gradient(180deg, var(--sidebar-bg) 0%, var(--sidebar-bg2) 100%);
      border-right: 1px solid var(--border);
      padding: 28px 22px 32px;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
      z-index: 2;
      scrollbar-width: thin;
      scrollbar-color: rgba(27,27,40,.10) transparent;
    }
    .sidebar::-webkit-scrollbar { width: 5px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(27,27,40,.10); border-radius: 99px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(27,27,40,.18); }

    /* Decorative top rule — red/blue party stripe */
    .sidebar::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, 
        var(--rep-color) 0%, var(--rep-color) 35%, 
        var(--bg-warm) 35%, var(--bg-warm) 50%,
        var(--muted-light) 50%, var(--muted-light) 52%,
        var(--bg-warm) 52%, var(--bg-warm) 65%,
        var(--dem-color) 65%, var(--dem-color) 100%
      );
      z-index: 10;
    }

    /* ── MAP AREA ── */
    .mapwrap {
      position: relative;
      overflow: hidden;
      background: var(--bg);
    }

    /* Cartographic grid pattern */
    .mapwrap::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(27,27,40,.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(27,27,40,.03) 1px, transparent 1px);
      background-size: 48px 48px;
      pointer-events: none;
      z-index: 0;
    }

    /* Subtle color wash + vignette */
    .mapwrap::after {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(ellipse at 30% 20%, rgba(43,74,140,.015) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 70%, rgba(192,57,43,.012) 0%, transparent 50%),
        radial-gradient(ellipse at center, transparent 40%, rgba(27,27,40,.025) 100%);
      pointer-events: none;
      z-index: 1;
    }

    #mapHost {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 0;
    }

    /* ═══════════════════════════════════════════
       TYPOGRAPHY
       ═══════════════════════════════════════════ */
    .title {
      font-family: var(--font-display);
      font-weight: 800;
      font-size: 26px;
      letter-spacing: -.03em;
      line-height: 1.1;
      margin: 0 0 2px;
      color: var(--text);
      position: relative;
      font-optical-sizing: auto;
    }

    .brand-sub {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: .14em;
      color: var(--muted);
      margin: 0 0 6px;
      text-transform: uppercase;
      font-weight: 500;
    }

    /* Decorative rule beneath header */
    .header-rule {
      width: 100%;
      height: 1px;
      background: var(--border-strong);
      margin: 0 0 18px;
      position: relative;
    }
    .header-rule::after {
      content: '✦';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: var(--sidebar-bg);
      padding: 0 10px;
      font-size: 9px;
      color: var(--muted-light);
      letter-spacing: .3em;
    }

    label {
      font-family: var(--font-body);
      font-size: 10.5px;
      font-weight: 600;
      color: var(--muted);
      display: block;
      margin: 14px 0 5px;
      letter-spacing: .1em;
      text-transform: uppercase;
    }

    /* ═══════════════════════════════════════════
       CARD
       ═══════════════════════════════════════════ */
    .card {
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 18px 18px 20px;
      background: var(--card-bg);
      margin: 0 0 16px;
      box-shadow: var(--card-shadow);
      position: relative;
      z-index: 1;
      transition: box-shadow .35s ease, border-color .3s ease;
    }
    .card:hover {
      box-shadow: var(--card-shadow-hover);
      border-color: var(--border-strong);
    }

    /* Top accent notch */
    .card::before {
      content: '';
      position: absolute;
      top: -1px; left: 24px;
      width: 40px; height: 3px;
      background: var(--accent);
      border-radius: 0 0 3px 3px;
    }

    /* ═══════════════════════════════════════════
       INPUTS
       ═══════════════════════════════════════════ */
    select, button {
      width: 100%;
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 500;
      outline: none;
      transition: all .2s ease;
      appearance: none;
      -webkit-appearance: none;
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7' fill='none'%3E%3Cpath d='M1 1.5L5 5.5L9 1.5' stroke='%237C7B8E' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
      cursor: pointer;
    }

    select:hover {
      border-color: var(--border-hover);
      background-color: #F5F3EF;
    }

    select:focus, button:focus {
      border-color: var(--accent-light);
      box-shadow: 0 0 0 3px var(--input-focus);
    }

    select option {
      background: var(--card-bg);
      color: var(--text);
    }

    button {
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      letter-spacing: .01em;
      position: relative;
      overflow: hidden;
    }
    button:hover {
      border-color: var(--border-hover);
      background: var(--accent-wash);
    }
    button:active {
      transform: scale(.98);
      transition: transform .06s;
    }

    button.secondary {
      background: var(--card-bg);
      border: 1px solid var(--border);
    }
    button.secondary:hover {
      background: var(--accent-wash);
      border-color: var(--accent-light);
      color: var(--accent);
    }

    /* ═══════════════════════════════════════════
       TABS
       ═══════════════════════════════════════════ */
    .tabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 8px 0 2px;
    }

    .tab {
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--card-bg);
      font-family: var(--font-body);
      font-size: 12.5px;
      font-weight: 600;
      cursor: pointer;
      transition: all .2s ease;
      text-align: center;
      color: var(--muted);
      position: relative;
    }

    .tab:hover {
      border-color: var(--border-hover);
      color: var(--text-secondary);
      background: var(--accent-wash);
    }

    .tab.active {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 8px rgba(43,74,140,.18), 0 1px 2px rgba(43,74,140,.12);
    }
    .tab.active:hover {
      background: var(--accent-light);
      color: #fff;
    }

    .subtabs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 14px;
    }

    /* ═══════════════════════════════════════════
       SECTION DIVIDERS
       ═══════════════════════════════════════════ */
    .section-divider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 18px 0 4px;
      font-family: var(--font-mono);
      font-size: 9px;
      font-weight: 600;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: var(--muted-light);
    }
    .section-divider::before,
    .section-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* ═══════════════════════════════════════════
       LEGEND
       ═══════════════════════════════════════════ */
    .legend {
      margin-top: 18px;
    }

    .legendbar {
      height: 18px;
      border-radius: var(--radius-xs);
      border: 1px solid var(--border);
      overflow: hidden;
      background: var(--bg);
      box-shadow: inset 0 1px 3px rgba(27,27,40,.06);
      position: relative;
    }

    .legendticks {
      display: flex;
      justify-content: space-between;
      font-family: var(--font-mono);
      font-size: 9.5px;
      font-weight: 600;
      color: var(--muted);
      margin-top: 5px;
      letter-spacing: .03em;
    }

    /* ═══════════════════════════════════════════
       HINT BOX
       ═══════════════════════════════════════════ */
    .hint {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      background: var(--accent-wash);
      border-left: 3px solid var(--accent);
      font-style: italic;
    }

    /* ═══════════════════════════════════════════
       STATS KV
       ═══════════════════════════════════════════ */
    .kv {
      font-size: 12px;
      color: var(--muted);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 2px 16px;
      margin-top: 14px;
      padding: 12px 0 0;
      border-top: 1px solid var(--border);
    }
    .kv div {
      padding: 4px 0;
      font-weight: 500;
    }
    .kv b {
      color: var(--text);
      font-family: var(--font-mono);
      font-weight: 600;
      font-size: 12px;
      padding: 4px 0;
    }

    /* ═══════════════════════════════════════════
       STATUS
       ═══════════════════════════════════════════ */
    .status {
      font-size: 11.5px;
      font-weight: 500;
      color: var(--muted);
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 8px 12px;
      background: var(--bg);
      border-radius: var(--radius-xs);
      border: 1px solid var(--border);
    }
    .status::before {
      content: '';
      display: inline-block;
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--ok);
      box-shadow: 0 0 6px rgba(30,132,73,.25);
      flex-shrink: 0;
      animation: status-pulse 2.5s ease-in-out infinite;
    }
    @keyframes status-pulse {
      0%,100% { opacity:.6; }
      50% { opacity:1; }
    }
    .status .ok { color: var(--ok); font-weight: 600; }
    .status .bad { color: var(--danger); font-weight: 600; }

    /* ═══════════════════════════════════════════
       LOADING OVERLAY
       ═══════════════════════════════════════════ */
    #overlay {
      position: absolute; inset: 0;
      background: rgba(245, 241, 235, .88);
      backdrop-filter: blur(12px);
      display: flex; align-items: center; justify-content: center;
      z-index: 20;
      animation: ov-in .25s ease-out;
    }
    @keyframes ov-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #overlay .box {
      width: min(520px, 88vw);
      border: 1px solid var(--border-strong);
      border-radius: 16px;
      background: var(--card-bg);
      padding: 28px 28px 24px;
      box-shadow:
        0 24px 80px rgba(27,27,40,.10),
        0 8px 24px rgba(27,27,40,.06),
        0 1px 3px rgba(27,27,40,.08);
      position: relative;
      overflow: hidden;
      animation: box-in .35s ease-out;
    }
    @keyframes box-in {
      from { opacity: 0; transform: translateY(10px) scale(.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Loading progress bar shimmer */
    #overlay .box::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      animation: load-shimmer 1.8s ease-in-out infinite;
    }
    @keyframes load-shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    #overlay .line1 {
      font-family: var(--font-display);
      font-weight: 700;
      margin: 0 0 8px;
      font-size: 18px;
      letter-spacing: -.02em;
      color: var(--text);
    }
    #overlay .line2 {
      margin: 0;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--muted);
      white-space: pre-wrap;
      line-height: 1.7;
    }
    #overlay .btnrow {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    #overlay button {
      width: auto;
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    /* ═══════════════════════════════════════════
       TOOLTIP
       ═══════════════════════════════════════════ */
    #tip {
      position: absolute;
      z-index: 15;
      pointer-events: none;
      transform: translate(14px, 14px);
      min-width: 230px;
      max-width: 340px;
      border: 1px solid var(--border-strong);
      border-radius: var(--radius);
      background: var(--card-bg);
      padding: 14px 16px;
      box-shadow:
        0 16px 48px rgba(27,27,40,.12),
        0 4px 12px rgba(27,27,40,.08),
        0 0 0 1px rgba(27,27,40,.03);
      opacity: 0;
      transition: opacity .1s ease;
    }
    #tip.show { opacity: 1; }

    /* Tooltip top accent */
    #tip::before {
      content: '';
      position: absolute;
      top: 0; left: 16px;
      width: 28px; height: 2px;
      background: var(--accent);
      border-radius: 0 0 2px 2px;
    }

    #tip .h {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 14px;
      margin: 0 0 6px;
      letter-spacing: -.01em;
      color: var(--text);
    }
    #tip .p {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }
    #tip .mono {
      font-family: var(--font-mono);
      font-size: 10.5px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* ═══════════════════════════════════════════
       SVG MAP PATHS
       ═══════════════════════════════════════════ */
    #txsvg path {
      fill: #C9C3B8;
      stroke: rgba(255,255,255,.7);
      stroke-width: .30;
      vector-effect: non-scaling-stroke;
      paint-order: stroke fill;
      stroke-linejoin: round;
      stroke-linecap: round;
      cursor: pointer;
      transition: stroke .06s, stroke-width .06s;
    }
    #txsvg path.miss {
      fill: #E2DED7;
    }
    #txsvg path.hover {
      stroke: var(--text);
      stroke-width: 1.2;
      filter: drop-shadow(0 0 4px rgba(27,27,40,.18));
    }

    /* ═══════════════════════════════════════════
       MISC ELEMENTS
       ═══════════════════════════════════════════ */
    .mini {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--muted-light);
      margin-top: 5px;
      letter-spacing: .01em;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-family: var(--font-display);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      letter-spacing: .01em;
      margin-bottom: 8px;
      background: var(--bg);
    }

    .mono {
      font-family: var(--font-mono) !important;
      font-size: 11px;
    }

    /* ═══════════════════════════════════════════
       CARTOGRAPHIC DECORATIONS
       ═══════════════════════════════════════════ */
    .compass {
      position: absolute;
      top: 20px; right: 22px;
      z-index: 3;
      width: 42px; height: 42px;
      pointer-events: none;
      opacity: .25;
    }
    .compass svg { width: 100%; height: 100%; }

    .scale-bar {
      position: absolute;
      bottom: 20px; left: 20px;
      z-index: 3;
      display: flex;
      flex-direction: column;
      gap: 3px;
      pointer-events: none;
    }
    .scale-bar .bar {
      display: flex;
      height: 4px;
      width: 80px;
      border-radius: 2px;
      overflow: hidden;
    }
    .scale-bar .bar span { flex: 1; }
    .scale-bar .bar span:nth-child(odd) { background: var(--muted-light); }
    .scale-bar .bar span:nth-child(even) { background: var(--bg-warm); }
    .scale-bar .lbl {
      font-family: var(--font-mono);
      font-size: 8px;
      letter-spacing: .1em;
      color: var(--muted-light);
      text-transform: uppercase;
    }

    /* ═══════════════════════════════════════════
       SIDEBAR FOOTER
       ═══════════════════════════════════════════ */
    .sidebar-footer {
      margin-top: 20px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--muted-light);
      letter-spacing: .06em;
      text-transform: uppercase;
    }
    .sidebar-footer .dot {
      width: 4px; height: 4px;
      border-radius: 50%;
      background: var(--muted-light);
      opacity: .4;
    }

    /* ═══════════════════════════════════════════
       RESPONSIVE
       ═══════════════════════════════════════════ */
    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      .sidebar {
        max-height: 48vh;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }
      :root { --sidebar-w: 1fr; }
      .compass, .scale-bar { display: none; }
    }

    .mapwrap::-webkit-scrollbar { display: none; }

    ::selection {
      background: rgba(43, 74, 140, .18);
      color: var(--text);
    }
  </style>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <h1 class="title">Texas Precinct<br>Dashboard</h1>
      <div class="brand-sub">SVG Choropleth Explorer</div>
      <div class="header-rule"></div>

      <div class="card">
        <div class="tabs">
          <div class="tab active" data-tab="results">Election results</div>
          <div class="tab" data-tab="swing">Election swing</div>
        </div>
        <div class="tabs" style="margin-top:8px;">
          <div class="tab" data-tab="trend">Trend index</div>
          <div class="tab" data-tab="trendChange">Trend change</div>
        </div>

        <label>Data file</label>
        <select id="dataFile"></select>
        <div class="mini">Best: <span class="mono">precinct-data-pctkey.csv</span> (must include <span class="mono">PCTKEY</span>).</div>

        <div id="panelResults" class="panel">
          <label>Contest</label>
          <select id="contest"></select>
        </div>

        <div id="panelSwing" class="panel" style="display:none;">
          <label>From</label>
          <select id="swingFrom"></select>
          <label>To</label>
          <select id="swingTo"></select>
        </div>

        <div id="panelTrend" class="panel" style="display:none;">
          <label>Contest</label>
          <select id="trendContest"></select>
          <label>Party</label>
          <select id="trendParty">
            <option value="D">Dem</option>
            <option value="R">Rep</option>
          </select>
        </div>

        <div id="panelTrendChange" class="panel" style="display:none;">
          <label>From</label>
          <select id="trendFrom"></select>
          <label>To</label>
          <select id="trendTo"></select>
          <label>Party</label>
          <select id="trendChangeParty">
            <option value="D">Dem</option>
            <option value="R">Rep</option>
          </select>
        </div>

        <div class="subtabs">
          <button id="fitBtn" class="secondary">Fit to view</button>
          <button id="resetBtn" class="secondary">Reset zoom</button>
        </div>

        <div class="section-divider">Legend</div>

        <div class="legend">
          <div class="pill" id="legendTitle">Margin</div>
          <div class="legendbar" id="legendBar"></div>
          <div class="legendticks" id="legendTicks"></div>
        </div>

        <div class="hint">
          Click a precinct for details. Hover highlights. If you open this via <span class="mono">file://</span>, fetch() will fail—serve with a local server.
        </div>

        <div class="section-divider">Diagnostics</div>

        <div class="kv" id="stats" style="border-top:none; padding-top:0;">
          <div>SVG paths</div><b id="statPaths">–</b>
          <div>Data rows</div><b id="statRows">–</b>
          <div>Matched</div><b id="statMatched">–</b>
          <div>Unmatched</div><b id="statUnmatched">–</b>
        </div>

        <div class="status" id="status">Status: <span class="ok">ready</span></div>
      </div>

      <div class="sidebar-footer">
        <span>Precinct-level data</span>
        <span class="dot"></span>
        <span>Interactive SVG</span>
      </div>
    </aside>

    <main class="mapwrap">
      <div id="mapHost"></div>
      <div id="tip"></div>

      <!-- Decorative cartographic elements -->
      <div class="compass">
        <svg viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="25" cy="25" r="23" stroke="currentColor" stroke-width=".6" opacity=".35"/>
          <circle cx="25" cy="25" r="18" stroke="currentColor" stroke-width=".4" opacity=".2"/>
          <line x1="25" y1="2" x2="25" y2="12" stroke="currentColor" stroke-width=".8" opacity=".5"/>
          <line x1="25" y1="38" x2="25" y2="48" stroke="currentColor" stroke-width=".6" opacity=".3"/>
          <line x1="2" y1="25" x2="12" y2="25" stroke="currentColor" stroke-width=".6" opacity=".3"/>
          <line x1="38" y1="25" x2="48" y2="25" stroke="currentColor" stroke-width=".6" opacity=".3"/>
          <text x="25" y="10" text-anchor="middle" font-size="5" font-family="var(--font-mono)" fill="currentColor" opacity=".5" font-weight="600">N</text>
        </svg>
      </div>

      <div class="scale-bar">
        <div class="bar"><span></span><span></span><span></span><span></span></div>
        <div class="lbl">approx. scale</div>
      </div>

      <div id="overlay" style="display:none;">
        <div class="box">
          <p class="line1" id="ovTitle">Loading…</p>
          <p class="line2" id="ovMsg">Starting…</p>
          <div class="btnrow">
            <button id="ovClose" class="secondary" style="display:none;">Close</button>
            <button id="ovReload" class="secondary" style="display:none;">Reload</button>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
(() => {
  "use strict";

  // ---------- Utilities ----------
  const $ = (sel) => document.querySelector(sel);
  const overlay = $("#overlay");
  const ovTitle = $("#ovTitle");
  const ovMsg = $("#ovMsg");
  const ovClose = $("#ovClose");
  const ovReload = $("#ovReload");

  function showOverlay(title, msg, {closable=false, reload=false} = {}) {
    ovTitle.textContent = title;
    ovMsg.textContent = msg;
    overlay.style.display = "flex";
    ovClose.style.display = closable ? "inline-block" : "none";
    ovReload.style.display = reload ? "inline-block" : "none";
  }
  function hideOverlay(){ overlay.style.display = "none"; }
  function nextFrame(){ return new Promise(r => requestAnimationFrame(() => r())); }

  function setStatus(text, ok=true){
    $("#status").innerHTML = `Status: <span class="${ok ? "ok":"bad"}">${escapeHtml(text)}</span>`;
  }
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function clamp(x,a,b){ return x<a?a : (x>b?b:x); }

  function gamma01(t, g){ return Math.pow(clamp(t,0,1), g); }
  function gammaSigned(z, g){
    const s = z < 0 ? -1 : 1;
    const a = Math.abs(z);
    return s * Math.pow(clamp(a,0,1), g);
  }

  // RGB helpers
  function hex2rgb(hex){
    const h = hex.replace("#","").trim();
    const n = parseInt(h,16);
    return [(n>>16)&255, (n>>8)&255, n&255];
  }
  function rgb2hex(r,g,b){
    const to = (v)=> v.toString(16).padStart(2,"0");
    return "#" + to(r) + to(g) + to(b);
  }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function lerpRgb(c0,c1,t){
    return [
      Math.round(lerp(c0[0],c1[0],t)),
      Math.round(lerp(c0[1],c1[1],t)),
      Math.round(lerp(c0[2],c1[2],t)),
    ];
  }

  // Palettes (precomputed for speed)
  // Light-mode optimized: warm neutral center, rich saturated endpoints
  const C_NEU = hex2rgb("#C4BDB2"); // warm light gray (neutral/toss-up)
  const C_D   = hex2rgb("#1862C6"); // rich Dem blue
  const C_R   = hex2rgb("#CC2D2D"); // rich Rep red
  const C_BG  = hex2rgb("#E2DED7"); // light cream (missing/unmatched)
  const PAL_N = 101;

  function paletteDiverging() {
    // t in [-1,1] => red<0, neutral at 0, blue>0
    const pal = new Array(PAL_N);
    for(let i=0;i<PAL_N;i++){
      const t = (i/(PAL_N-1))*2 - 1;
      if (t < 0){
        const c = lerpRgb(C_NEU, C_R, -t);
        pal[i] = rgb2hex(c[0],c[1],c[2]);
      } else {
        const c = lerpRgb(C_NEU, C_D, t);
        pal[i] = rgb2hex(c[0],c[1],c[2]);
      }
    }
    return pal;
  }

  function paletteSequential(party){
    // t in [0,1] => neutral -> party color
    const to = (party==="D") ? C_D : C_R;
    const pal = new Array(PAL_N);
    for(let i=0;i<PAL_N;i++){
      const t = i/(PAL_N-1);
      const c = lerpRgb(C_NEU, to, t);
      pal[i] = rgb2hex(c[0],c[1],c[2]);
    }
    return pal;
  }

  const PAL_MARGIN = paletteDiverging();
  const PAL_SEQ_D = paletteSequential("D");
  const PAL_SEQ_R = paletteSequential("R");
  const FILL_MISS = rgb2hex(C_BG[0],C_BG[1],C_BG[2]);

  // ---------- App state ----------
  const state = {
    tab: "results",
    svg: null,
    paths: null,
    panzoom: null,
    joinIndex: null,
    keyOfPath: null,
    data: null,
    keyCol: null,
    contests: [],
    contestKey: null,
    swingFrom: null,
    swingTo: null,
    trendContest: null,
    trendParty: "D",
    trendFrom: null,
    trendTo: null,
    trendChangeParty: "D",
    prevBin: null,
    lastHover: null
  };

  // ---------- DOM refs ----------
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const panelResults = $("#panelResults");
  const panelSwing = $("#panelSwing");
  const panelTrend = $("#panelTrend");
  const panelTrendChange = $("#panelTrendChange");

  const selDataFile = $("#dataFile");
  const selContest = $("#contest");
  const selSwingFrom = $("#swingFrom");
  const selSwingTo = $("#swingTo");
  const selTrendContest = $("#trendContest");
  const selTrendParty = $("#trendParty");
  const selTrendFrom = $("#trendFrom");
  const selTrendTo = $("#trendTo");
  const selTrendChangeParty = $("#trendChangeParty");

  const legendTitle = $("#legendTitle");
  const legendBar = $("#legendBar");
  const legendTicks = $("#legendTicks");
  const tip = $("#tip");

  // ---------- Initialization ----------
  ovClose.onclick = () => hideOverlay();
  ovReload.onclick = () => location.reload();

  if (location.protocol === "file:") {
    showOverlay("Blocked by browser", "You're opening index.html via file://.\n\nBrowsers block fetch() for local files.\nUse GitHub Pages or run a local server:\n  python3 -m http.server 8000\nthen open:\n  http://localhost:8000/", {reload:false, closable:false});
  } else {
    main().catch(err => fatal(err));
  }

  async function main(){
    showOverlay("Loading…", "Starting…");
    await nextFrame();

    setStatus("loading svg…", true);
    const svgUrl = await firstAvailable([
      "./Precincts24G_keyed_simplified.svg",
      "./Precincts24G.svg",
      "./Precincts24G_WGS84/Precincts24G.svg",
    ]);

    if (!svgUrl) throw new Error("SVG not found. Put Precincts24G_keyed_simplified.svg or Precincts24G.svg next to index.html.");

    showOverlay("Loading…", `Fetching SVG:\n${svgUrl}`);
    await nextFrame();
    const svgText = await fetchText(svgUrl);

    showOverlay("Loading…", "Parsing SVG (this can take a few seconds)…");
    await nextFrame();
    const svgEl = parseSvg(svgText);
    svgEl.setAttribute("id","txsvg");
    svgEl.removeAttribute("width");
    svgEl.removeAttribute("height");
    svgEl.style.width = "100%";
    svgEl.style.height = "100%";
    svgEl.style.display = "block";

    const host = $("#mapHost");
    host.replaceChildren(svgEl);
    state.svg = svgEl;

    const paths = svgEl.querySelectorAll("path");
    state.paths = paths;
    state.prevBin = new Int16Array(paths.length);
    state.prevBin.fill(-32768);
    $("#statPaths").textContent = String(paths.length);

    state.keyOfPath = (i) => {
      const p = paths[i];
      return p.getAttribute("data-pctkey") || p.getAttribute("data-PCTKEY") || p.id || "";
    };

    showOverlay("Loading…", "Initializing pan/zoom…");
    await nextFrame();
    state.panzoom = svgPanZoom(svgEl, {
      zoomEnabled: true,
      controlIconsEnabled: false,
      fit: true,
      center: true,
      minZoom: 1,
      maxZoom: 40,
      dblClickZoomEnabled: true,
      mouseWheelZoomEnabled: true,
      preventMouseEventsDefault: true
    });

    $("#fitBtn").onclick = () => { state.panzoom.fit(); state.panzoom.center(); };
    $("#resetBtn").onclick = () => { state.panzoom.resetZoom(); state.panzoom.center(); };
    tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

    selContest.addEventListener("change", () => { state.contestKey = selContest.value; scheduleRender(); });
    selSwingFrom.addEventListener("change", () => { state.swingFrom = selSwingFrom.value; scheduleRender(); });
    selSwingTo.addEventListener("change", () => { state.swingTo = selSwingTo.value; scheduleRender(); });
    selTrendContest.addEventListener("change", () => { state.trendContest = selTrendContest.value; scheduleRender(); });
    selTrendParty.addEventListener("change", () => { state.trendParty = selTrendParty.value; scheduleRender(); });
    selTrendFrom.addEventListener("change", () => { state.trendFrom = selTrendFrom.value; scheduleRender(); });
    selTrendTo.addEventListener("change", () => { state.trendTo = selTrendTo.value; scheduleRender(); });
    selTrendChangeParty.addEventListener("change", () => { state.trendChangeParty = selTrendChangeParty.value; scheduleRender(); });

    const dataChoices = [
      {label:"precinct-data-pctkey.csv", url:"./precinct-data-pctkey.csv"},
      {label:"precinct-data-pctkey_auto.csv", url:"./precinct-data-pctkey_auto.csv"},
      {label:"precinct-data.csv", url:"./precinct-data.csv"}
    ];
    for (const ch of dataChoices){
      const opt = document.createElement("option");
      opt.value = ch.url;
      opt.textContent = ch.label;
      selDataFile.appendChild(opt);
    }
    const dataUrl = await firstAvailable(dataChoices.map(x=>x.url));
    selDataFile.value = dataUrl || dataChoices[0].url;
    selDataFile.addEventListener("change", () => loadData(selDataFile.value));

    await loadData(selDataFile.value);

    svgEl.addEventListener("mousemove", onMove, {passive:true});
    svgEl.addEventListener("mouseleave", () => { hideTip(); clearHover(); }, {passive:true});
    svgEl.addEventListener("click", onClick, {passive:true});

    hideOverlay();
    setStatus("ready", true);
    scheduleRender();
  }

  async function loadData(url){
    setStatus("loading data…", true);
    showOverlay("Loading…", `Fetching CSV:\n${url}`);
    await nextFrame();
    const csvText = await fetchText(url);

    showOverlay("Loading…", "Parsing CSV…");
    await nextFrame();
    const rows = parseCsv(csvText);
    state.data = rows;
    $("#statRows").textContent = String(rows.length);

    const cols = rows.columns;
    const keyCol = cols.includes("PCTKEY") ? "PCTKEY" :
                   (cols.includes("pctkey") ? "pctkey" :
                   (cols.includes("GEOID20") ? "GEOID20" : null));
    state.keyCol = keyCol;

    if (!keyCol) throw new Error("CSV missing a key column. Need PCTKEY (preferred) or GEOID20.");

    const contests = detectContests(cols);
    if (!contests.length) throw new Error("No contests found. Expected columns like E_24_PRES_Dem / _Rep / _Total.");

    showOverlay("Loading…", "Indexing contests…");
    await nextFrame();

    const rowCount = rows.length;
    for (const c of contests){
      c.demArr = new Float64Array(rowCount);
      c.repArr = new Float64Array(rowCount);
      c.totArr = new Float64Array(rowCount);
      let sd=0, sr=0;
      for (let i=0;i<rowCount;i++){
        const r = rows[i];
        const d = +r[c.demCol] || 0;
        const rr = +r[c.repCol] || 0;
        const t = (+r[c.totCol] || (d+rr));
        c.demArr[i]=d;
        c.repArr[i]=rr;
        c.totArr[i]=t;
        sd += d;
        sr += rr;
      }
      const st = sd + sr;
      c.stateDemPct = st>0 ? (sd/st) : 0.5;
      c.stateRepPct = st>0 ? (sr/st) : 0.5;
    }

    state.contests = contests;

    fillContestSelect(selContest, contests);
    fillContestSelect(selSwingFrom, contests);
    fillContestSelect(selSwingTo, contests);
    fillContestSelect(selTrendContest, contests);
    fillContestSelect(selTrendFrom, contests);
    fillContestSelect(selTrendTo, contests);

    state.contestKey = contests[0].key;
    state.swingFrom = contests[0].key;
    state.swingTo = contests[Math.min(1, contests.length-1)].key;
    state.trendContest = contests[0].key;
    state.trendFrom = contests[0].key;
    state.trendTo = contests[Math.min(1, contests.length-1)].key;

    selContest.value = state.contestKey;
    selSwingFrom.value = state.swingFrom;
    selSwingTo.value = state.swingTo;
    selTrendContest.value = state.trendContest;
    selTrendFrom.value = state.trendFrom;
    selTrendTo.value = state.trendTo;

    showOverlay("Loading…", "Matching SVG precincts to data…");
    await nextFrame();
    buildJoin();

    hideOverlay();
    setStatus("ready", true);
    scheduleRender();
  }

  function buildJoin(){
    const paths = state.paths;
    const rows = state.data;
    const keyCol = state.keyCol;

    const keyToRow = new Map();
    for (let i=0;i<rows.length;i++){
      const k = String(rows[i][keyCol] ?? "").trim();
      if (!k) continue;
      if (!keyToRow.has(k)) keyToRow.set(k, i);
    }

    const join = new Int32Array(paths.length);
    let matched=0;
    for (let i=0;i<paths.length;i++){
      const k = String(state.keyOfPath(i)).trim();
      const idx = keyToRow.has(k) ? keyToRow.get(k) : -1;
      join[i]=idx;
      if (idx!==-1) matched++;
      if (idx===-1) paths[i].classList.add("miss");
      else paths[i].classList.remove("miss");
    }
    state.joinIndex = join;
    $("#statMatched").textContent = String(matched);
    $("#statUnmatched").textContent = String(paths.length - matched);

    if (matched < Math.floor(paths.length*0.95)) {
      setStatus(`low match (${matched}/${paths.length}) — use precinct-data-pctkey.csv`, false);
    }
  }

  function detectContests(columns){
    const out = [];
    const demCols = columns.filter(c => c.endsWith("_Dem") && c.startsWith("E_"));
    for (const dem of demCols){
      const base = dem.slice(0, -4);
      const rep = base + "_Rep";
      const tot = base + "_Total";
      if (!columns.includes(rep) || !columns.includes(tot)) continue;
      out.push({
        key: base,
        label: prettyContest(base),
        demCol: dem,
        repCol: rep,
        totCol: tot
      });
    }
    out.sort((a,b) => a.key.localeCompare(b.key));
    return out;
  }

  function prettyContest(k){
    const parts = k.split("_");
    if (parts.length >= 3 && parts[0]==="E"){
      const yy = parts[1];
      const year = (yy.length===2 ? ("20"+yy) : yy);
      const race = parts.slice(2).join("_").replaceAll("-", "–");
      return `${year} ${race}`;
    }
    return k;
  }

  function fillContestSelect(sel, contests){
    sel.innerHTML = "";
    for (const c of contests){
      const opt = document.createElement("option");
      opt.value = c.key;
      opt.textContent = c.label;
      sel.appendChild(opt);
    }
  }

  function setTab(tab){
    state.tab = tab;
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab===tab));
    panelResults.style.display = (tab==="results") ? "" : "none";
    panelSwing.style.display = (tab==="swing") ? "" : "none";
    panelTrend.style.display = (tab==="trend") ? "" : "none";
    panelTrendChange.style.display = (tab==="trendChange") ? "" : "none";
    scheduleRender();
  }

  // ---------- Rendering ----------
  let renderQueued = false;
  function scheduleRender(){
    if (renderQueued) return;
    renderQueued = true;
    requestAnimationFrame(() => {
      renderQueued = false;
      try { render(); }
      catch(err){ fatal(err); }
    });
  }

  function getContest(key){
    return state.contests.find(c => c.key === key) || null;
  }

  function render(){
    if (!state.paths || !state.joinIndex || !state.contests.length) return;

    const tab = state.tab;
    const paths = state.paths;
    const join = state.joinIndex;

    let vmin= -1, vmax= 1;
    let palette = PAL_MARGIN;
    let legend = {title:"Margin", ticks:["R+60","0","D+60"], gradient: gradientCss(PAL_MARGIN)};
    let valueFn = null;

    if (tab === "results"){
      const c = getContest(state.contestKey);
      if (!c) return;
      legend = {title:`Margin · ${c.label}`, ticks:["R+60","0","D+60"], gradient: gradientCss(PAL_MARGIN)};
      valueFn = (rowIdx) => margin(c.demArr[rowIdx], c.repArr[rowIdx]);
      vmin = -0.60; vmax = 0.60;
      palette = PAL_MARGIN;
    } else if (tab === "swing"){
      const c0 = getContest(state.swingFrom);
      const c1 = getContest(state.swingTo);
      if (!c0 || !c1) return;
      legend = {title:`Swing · ${c0.label} → ${c1.label}`, ticks:["R swing","0","D swing"], gradient: gradientCss(PAL_MARGIN)};
      valueFn = (rowIdx) => margin(c1.demArr[rowIdx], c1.repArr[rowIdx]) - margin(c0.demArr[rowIdx], c0.repArr[rowIdx]);
      vmin = -0.30; vmax = 0.30;
      palette = PAL_MARGIN;
    } else if (tab === "trend"){
      const c = getContest(state.trendContest);
      if (!c) return;
      const party = state.trendParty;
      const pal = (party==="D") ? PAL_SEQ_D : PAL_SEQ_R;
      legend = {title:`Trend index · ${party==="D"?"Dem":"Rep"} · ${c.label}`, ticks:["0","50","100"], gradient: gradientCss(pal)};
      valueFn = (rowIdx) => trendIndex(c, rowIdx, party);
      vmin = 0; vmax = 100;
      palette = pal;
    } else if (tab === "trendChange"){
      const c0 = getContest(state.trendFrom);
      const c1 = getContest(state.trendTo);
      if (!c0 || !c1) return;
      const party = state.trendChangeParty;
      legend = {title:`Trend change · ${party==="D"?"Dem":"Rep"} · ${c0.label} → ${c1.label}`, ticks:["shift R","0","shift D"], gradient: gradientCss(PAL_MARGIN)};
      valueFn = (rowIdx) => {
        const d = trendIndex(c1, rowIdx, party) - trendIndex(c0, rowIdx, party);
        return (party==="R") ? -d/50 : d/50;
      };
      vmin = -1; vmax = 1;
      palette = PAL_MARGIN;
    }

    legendTitle.textContent = legend.title;
    legendBar.style.background = legend.gradient;
    legendTicks.innerHTML = legend.ticks.map(t=>`<div>${escapeHtml(t)}</div>`).join("");

    const inv = 1.0 / (vmax - vmin);
    const palN1 = palette.length - 1;
    const prev = state.prevBin;

    let updates = 0;
    for (let i=0;i<paths.length;i++){
      const rowIdx = join[i];
      if (rowIdx === -1){
        if (prev[i] !== -30000){
          paths[i].style.fill = FILL_MISS;
          prev[i] = -30000;
          updates++;
        }
        continue;
      }
      const v = valueFn(rowIdx);
      if (!Number.isFinite(v)){
        if (prev[i] !== -30000){
          paths[i].style.fill = FILL_MISS;
          prev[i] = -30000;
          updates++;
        }
        continue;
      }
      let t = clamp((v - vmin) * inv, 0, 1);
      if (palette === PAL_MARGIN) {
        const z = (t * 2) - 1;
        const zg = gammaSigned(z, 0.62);
        t = (zg + 1) * 0.5;
      } else {
        t = gamma01(t, 0.65);
      }
      const bin = (t * palN1 + 0.5) | 0;
      if (bin !== prev[i]){
        paths[i].style.fill = palette[bin];
        prev[i] = bin;
        updates++;
      }
    }
    setStatus(`ready (${updates} updates)`, true);
  }

  function gradientCss(palette){
    const stops = 12;
    const parts = [];
    for (let i=0;i<=stops;i++){
      const t = i/stops;
      const idx = Math.round(t*(palette.length-1));
      parts.push(`${palette[idx]} ${Math.round(t*100)}%`);
    }
    return `linear-gradient(90deg, ${parts.join(",")})`;
  }

  function margin(d,r){
    const t = d + r;
    return t>0 ? (d - r) / t : 0;
  }

  function trendIndex(contest, rowIdx, party){
    const d = contest.demArr[rowIdx];
    const r = contest.repArr[rowIdx];
    const t = d + r;
    if (t<=0) return NaN;
    const p = (party==="D") ? (d/t) : (r/t);
    const s = (party==="D") ? contest.stateDemPct : contest.stateRepPct;
    if (s<=0) return NaN;
    return 50 * (p / s);
  }

  // ---------- Tooltip / hover ----------
  function onMove(ev){
    const target = ev.target.closest ? ev.target.closest("path") : null;
    if (!target || target.ownerSVGElement !== state.svg) { clearHover(); hideTip(); return; }
    if (state.lastHover !== target){
      clearHover();
      target.classList.add("hover");
      state.lastHover = target;
    }
    const idx = indexOfPath(target);
    if (idx < 0) { hideTip(); return; }
    const rowIdx = state.joinIndex[idx];
    if (rowIdx === -1) { hideTip(); return; }
    const info = buildInfo(rowIdx);
    showTip(ev, info);
  }

  function onClick(ev){ onMove(ev); }

  function indexOfPath(pathEl){
    if (pathEl.__idx !== undefined) return pathEl.__idx;
    const paths = state.paths;
    for (let i=0;i<paths.length;i++){
      if (paths[i] === pathEl) { pathEl.__idx = i; return i; }
    }
    pathEl.__idx = -1;
    return -1;
  }

  function clearHover(){
    if (state.lastHover){
      state.lastHover.classList.remove("hover");
      state.lastHover = null;
    }
  }

  function showTip(ev, info){
    tip.style.left = ev.clientX + "px";
    tip.style.top = ev.clientY + "px";
    tip.innerHTML = info;
    tip.classList.add("show");
  }
  function hideTip(){ tip.classList.remove("show"); }

  function buildInfo(rowIdx){
    const r = state.data[rowIdx];
    const keyCol = state.keyCol;
    const key = String(r[keyCol] ?? "");
    const name = (r.Name !== undefined) ? String(r.Name) : "";

    const tab = state.tab;
    let block = "";
    if (tab==="results"){
      const c = getContest(state.contestKey);
      if (c){
        const d = c.demArr[rowIdx], rr = c.repArr[rowIdx];
        const t = d+rr;
        const m = margin(d, rr);
        block = `<div class="p">${escapeHtml(c.label)}<br><span class="mono">D ${d.toFixed(0)} · R ${rr.toFixed(0)} · margin ${(m*100).toFixed(2)}%</span></div>`;
      }
    } else if (tab==="swing"){
      const c0 = getContest(state.swingFrom), c1 = getContest(state.swingTo);
      if (c0 && c1){
        const sw = margin(c1.demArr[rowIdx], c1.repArr[rowIdx]) - margin(c0.demArr[rowIdx], c0.repArr[rowIdx]);
        block = `<div class="p">${escapeHtml(c0.label)} → ${escapeHtml(c1.label)}<br><span class="mono">margin swing ${(sw*100).toFixed(2)}%</span></div>`;
      }
    } else if (tab==="trend"){
      const c = getContest(state.trendContest);
      if (c){
        const party = state.trendParty;
        const idx = trendIndex(c, rowIdx, party);
        block = `<div class="p">${escapeHtml(c.label)}<br><span class="mono">${party} index ${idx.toFixed(1)}</span></div>`;
      }
    } else if (tab==="trendChange"){
      const c0 = getContest(state.trendFrom), c1 = getContest(state.trendTo);
      if (c0 && c1){
        const party = state.trendChangeParty;
        const idx0 = trendIndex(c0, rowIdx, party);
        const idx1 = trendIndex(c1, rowIdx, party);
        const d = idx1 - idx0;
        block = `<div class="p">${escapeHtml(c0.label)} → ${escapeHtml(c1.label)}<br><span class="mono">${party} index Δ ${d.toFixed(1)}</span></div>`;
      }
    }

    return `
      <div class="h">${escapeHtml(name || "Precinct")}</div>
      <div class="p"><span class="mono">${escapeHtml(keyCol)}=${escapeHtml(key)}</span></div>
      ${block}
    `;
  }

  // ---------- IO ----------
  async function fetchText(url){
    const res = await fetch(url, {cache:"no-store"});
    if (!res.ok) throw new Error(`Fetch failed (${res.status}) for ${url}`);
    return await res.text();
  }

  function parseSvg(svgText){
    const parser = new DOMParser();
    const doc = parser.parseFromString(svgText, "image/svg+xml");
    const svg = doc.querySelector("svg");
    if (!svg) throw new Error("Invalid SVG (no <svg> root).");
    doc.querySelectorAll("script").forEach(n => n.remove());
    return svg;
  }

  function parseCsv(csvText){
    const parsed = Papa.parse(csvText, {header:true, dynamicTyping:true, skipEmptyLines:true});
    if (parsed.errors && parsed.errors.length){
      const e = parsed.errors[0];
      throw new Error(`CSV parse error: ${e.message} at row ${e.row}`);
    }
    const rows = parsed.data;
    rows.columns = parsed.meta.fields || [];
    return rows;
  }

  async function firstAvailable(urls){
    for (const u of urls){
      try{
        const res = await fetch(u, {method:"HEAD", cache:"no-store"});
        if (res.ok) return u;
      } catch(_){ }
    }
    return null;
  }

  function fatal(err){
    console.error(err);
    const msg = (err && err.stack) ? err.stack : String(err);
    showOverlay("Error", msg, {closable:true, reload:true});
    setStatus("error (see overlay)", false);
  }
})();
</script>
</body>
</html>
